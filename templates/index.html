<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>批量领取</title>
  <style>
    body { font-family: monospace; background: #111; color: #0f0; padding: 20px; }
    textarea, input { width: 100%; margin-top: 10px; }
    #output { white-space: pre-wrap; margin-top: 20px; background: #222; border-radius: 8px; padding: 10px; min-height: 120px;}
    .success { color: #0f0; }
    .fail { color: #f44; }
    .txhash { color: #1ed760; text-decoration: underline; }
    .address { color: #c2e; }
    .proxy { color: #5af; }
  </style>
</head>
<body>
  <h2>批量领取工具</h2>
  <form id="mainForm">
    <label>钱包地址（每行一个）:</label><br>
    <textarea id="addresses" rows="5"></textarea><br>
    <label>代理列表（ip:port:user:pass）:</label><br>
    <textarea id="proxies" rows="5"></textarea><br>
    <label>YesCaptcha API Key:</label><br>
    <input id="clientKey"><br>
    <button type="submit">开始领取</button>
    <button type="button" id="queryHistory" style="margin-top: 10px;">刷新结果</button>
  </form>
  <div id="output"></div>
  <script>
    function renderResults(results) {
      let html = '';
      for (const row of results) {
        html +=
          `<div>
            <span class="address">${row.address}</span>
            <span class="proxy"> [${row.proxy}]</span>
            <span class="${row.success ? 'success' : 'fail'}">${row.msg}</span>
            ${row.txhash ? `<span class="txhash">Txhash: <a href="https://testnet.bscscan.com/tx/${row.txhash}" target="_blank">${row.txhash}</a></span>` : ''}
          </div>\n`;
      }
      document.getElementById("output").innerHTML = html;
    }

    document.getElementById("mainForm").onsubmit = function(e) {
      e.preventDefault();
      const addresses = document.getElementById("addresses").value;
      const proxies = document.getElementById("proxies").value;
      const clientKey = document.getElementById("clientKey").value;
      document.getElementById("output").textContent = "领取中，请稍候...\n";
      fetch('/run', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ addresses, proxies, client_key: clientKey })
      })
      .then(r => r.json())
      .then(res => renderResults(res.results))
      .catch(err => { document.getElementById("output").textContent = "❌ 提交失败 " + err; });
    };

    document.getElementById("queryHistory").onclick = function() {
      fetch('/history')
      .then(r => r.json())
      .then(res => renderResults(res.results));
    };
  </script>
</body>
</html>
