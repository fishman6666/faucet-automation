<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æ‰¹é‡è‡ªåŠ¨é¢†å–</title>
  <style>
    body { background: #1a1a1a; color: #e5ffe5; font-family: "Consolas", "Menlo", monospace; padding: 32px; }
    h2 { color: #93ff6f; }
    textarea, input { width: 100%; margin-top: 10px; background: #222; color: #8ffe8f; border: 1px solid #444; border-radius: 4px; padding: 8px; font-size: 15px; }
    button { background: #59dd75; color: #111; border: none; border-radius: 4px; padding: 10px 32px; margin-top: 16px; font-weight: bold; cursor: pointer; }
    button:active { background: #338744; }
    #succ, #fail { white-space: pre-wrap; background: #181818; border: 1px solid #2a2a2a; border-radius: 8px; min-height: 80px; padding: 10px; font-size: 15px; margin-top: 16px; }
    .txhash { color: #ffe066; font-weight: bold; }
    .fail { color: #ff5e5e; }
    .success { color: #6cff70; }
    .copy-btn { background: #27bbff; color: #111; border-radius: 4px; border: none; font-size: 14px; margin-left: 8px; padding: 7px 14px; cursor: pointer;}
  </style>
</head>
<body>
  <h2>æ‰¹é‡è‡ªåŠ¨é¢†å–å·¥å…·</h2>
  <form id="mainForm" autocomplete="off">
    <label>é’±åŒ…åœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰:</label><br>
    <textarea id="addresses" rows="5" placeholder="0x..."></textarea><br>
    <label>ä»£ç†åˆ—è¡¨ï¼ˆip:port:user:pass[:SOCKS5]ï¼‰:</label><br>
    <textarea id="proxies" rows="5" placeholder="ip:ç«¯å£:è´¦å·:å¯†ç  æˆ– ip:ç«¯å£:è´¦å·:å¯†ç :SOCKS5"></textarea><br>
    <label>YesCaptcha API Key:</label><br>
    <input id="clientKey" placeholder="API Key"><br>
    <button type="submit">å¼€å§‹é¢†å–</button>
    <button type="button" id="historyBtn" style="margin-left:18px;background:#27bbff;color:#111;">æŸ¥è¯¢å†å²ç»“æœ</button>
  </form>

  <div>
    <div><b>é¢†å–æˆåŠŸï¼š</b></div>
    <div id="succ"></div>
    <div style="margin-top:8px;"><b>å¤±è´¥é’±åŒ…ï¼ˆå¯å¤åˆ¶é‡è¯•ï¼‰ï¼š</b>
      <button type="button" class="copy-btn" onclick="copyFail()">å¤åˆ¶å¤±è´¥é’±åŒ…</button>
    </div>
    <div id="fail"></div>
  </div>

  <script>
    let evtSource = null;
    const succDiv = document.getElementById("succ");
    const failDiv = document.getElementById("fail");

    function showResult(list) {
      succDiv.innerHTML = "";
      failDiv.innerHTML = "";
      let failAddrs = [];
      list.forEach(line => {
        if(line.includes("é¢†å–æˆåŠŸ")) {
          succDiv.innerHTML += line.replace(/é¢†å–æˆåŠŸï¼Txhash: <span class='txhash'>([^<]+)<\/span>/g,
            "<span class='success'>ğŸ‰ é¢†å–æˆåŠŸï¼Txhash: <span class='txhash'>$1</span></span>") + "\n";
        } else if(line.startsWith("âŒ")) {
          failDiv.innerHTML += `<span class="fail">${line}</span>\n`;
          const m = line.match(/^(?:âŒ )?(0x[a-fA-F0-9]{40})/);
          if(m) failAddrs.push(m[1]);
        }
      });
      failDiv.setAttribute("data-fails", failAddrs.join("\n"));
    }

    function copyFail() {
      const txt = failDiv.getAttribute("data-fails") || "";
      if(txt) {
        navigator.clipboard.writeText(txt);
        alert("å·²å¤åˆ¶å¤±è´¥é’±åŒ…åœ°å€ï¼");
      } else {
        alert("æ²¡æœ‰å¯å¤åˆ¶çš„å¤±è´¥é’±åŒ…åœ°å€ã€‚");
      }
    }

    document.getElementById("mainForm").onsubmit = function(e) {
      e.preventDefault();
      if (evtSource) evtSource.close();
      succDiv.innerHTML = "å¼€å§‹è¿æ¥...\n"; failDiv.innerHTML = "";
      const addresses = document.getElementById("addresses").value;
      const proxies = document.getElementById("proxies").value;
      const clientKey = document.getElementById("clientKey").value;
      const params = new URLSearchParams({ addresses, proxies, client_key: clientKey });
      let results = [];
      evtSource = new EventSource(`/run?${params.toString()}`);

      evtSource.onmessage = function(e) {
        const line = e.data.trim();
        if (!line) return;
        results.push(line);
        showResult(results);
      };
      evtSource.onerror = function(e) { evtSource && evtSource.close(); };
    }

    document.getElementById("historyBtn").onclick = function() {
      if (evtSource) evtSource.close();
      succDiv.innerHTML = "æŸ¥è¯¢å†å²é¢†å–ç»“æœä¸­...\n"; failDiv.innerHTML = "";
      fetch("/results")
        .then(resp => resp.json())
        .then(list => showResult(list))
        .catch(() => {succDiv.innerHTML = "æŸ¥è¯¢å¤±è´¥ï¼";});
    };
  </script>
</body>
</html>
