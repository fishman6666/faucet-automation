<script>
  // å®æ—¶ç»Ÿè®¡æ€»æ•°+å”¯ä¸€æ•°
  function updateCounts() {
    const a = document.getElementById("addresses").value.trim().split('\n').filter(l=>l.trim());
    const aUnique = [...new Set(a)];
    const p = document.getElementById("proxies").value.trim().split('\n').filter(l=>l.trim());
    const pUnique = [...new Set(p)];
    let warnA = a.length !== aUnique.length ? `<span class="count-warn">æœ‰é‡å¤</span>` : '';
    let warnP = p.length !== pUnique.length ? `<span class="count-warn">æœ‰é‡å¤</span>` : '';
    document.getElementById("addresses_count").innerHTML =
      `åœ°å€æ•°é‡ï¼š<span>${a.length}</span>ï¼Œå”¯ä¸€ï¼š<span>${aUnique.length}</span> ${warnA}`;
    document.getElementById("proxies_count").innerHTML =
      `ä»£ç†æ•°é‡ï¼š<span>${p.length}</span>ï¼Œå”¯ä¸€ï¼š<span>${pUnique.length}</span> ${warnP}`;
  }
  document.getElementById("addresses").addEventListener('input', updateCounts);
  document.getElementById("proxies").addEventListener('input', updateCounts);
  updateCounts();

  const output = document.getElementById("output");

  function addLine(line) {
    line = line
      .replace(/é¢†å–æˆåŠŸï¼Txhash: <span class='txhash'>([^<]+)<\/span>/g,
          "<span class='success'>ğŸ‰ é¢†å–æˆåŠŸï¼Txhash: <span class='txhash'>$1</span></span>")
      .replace(/^âŒ.*å¤±è´¥.*/gm, txt => `<span class='fail'>${txt}</span>`)
      .replace(/^\[å¿ƒè·³\].*/gm, txt => `<span class='heartbeat'>${txt}</span>`);
    output.innerHTML += line + "\n";
    output.scrollTop = output.scrollHeight;
  }

  // ä½¿ç”¨POST+æµå¼æ–¹å¼ï¼Œä¸å†ç”¨EventSource
  document.getElementById("mainForm").onsubmit = async function(e) {
    e.preventDefault();
    output.innerHTML = "å¼€å§‹è¿æ¥...\n";
    const addresses = document.getElementById("addresses").value;
    const proxies = document.getElementById("proxies").value;
    const clientKey = document.getElementById("clientKey").value;

    // fetchæµå¼POST
    const res = await fetch("/run", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ addresses, proxies, client_key: clientKey })
    });
    if (!res.body) {
      output.innerHTML += "âŒ è¯·æ±‚å¤±è´¥ï¼";
      return;
    }
    const reader = res.body.getReader();
    let decoder = new TextDecoder();
    let partial = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      let chunk = decoder.decode(value, {stream:true});
      partial += chunk;
      let lines = partial.split('\n\n');
      partial = lines.pop();
      lines.forEach(line => {
        const match = /^data:\s*(.*)/.exec(line);
        if (match) addLine(match[1]);
      });
    }
  }

  // æŸ¥è¯¢å†å²å”¯ä¸€å¤±è´¥/æˆåŠŸ
  document.getElementById("btn-query").onclick = async function() {
    output.innerHTML = "æŸ¥è¯¢ä¸­...\n";
    let resp = await fetch('/results');
    let text = await resp.text();
    let succ = [], fail = [];
    text.split('\n').forEach(line => {
      if (line.startsWith("ğŸ‰")) succ.push(line);
      if (line.startsWith("âŒ")) fail.push(line);
    });
    output.innerHTML = `<div class='section-title'>ğŸ‰ æˆåŠŸ</div>${succ.join('<br>') || 'æ— '}<br>
                        <div class='section-title'>âŒ å¤±è´¥ï¼ˆå”¯ä¸€ï¼‰</div>${fail.join('<br>') || 'æ— '}`;
    output.scrollTop = output.scrollHeight;
    window.lastFailLines = fail.map(line=>{
      let m = line.match(/âŒ (\w{42})/); return m ? m[1] : null;
    }).filter(x=>x).join("\n");
  };

  // ä¸€é”®å¤åˆ¶å¤±è´¥åœ°å€
  document.getElementById("btn-copy-fail").onclick = function() {
    if (!window.lastFailLines) {
      alert("è¯·å…ˆç‚¹å‡»ã€æŸ¥è¯¢å†å²ç»“æœã€‘å†å¤åˆ¶å”¯ä¸€å¤±è´¥åœ°å€ï¼");
      return;
    }
    navigator.clipboard.writeText(window.lastFailLines).then(()=>{
      alert("å”¯ä¸€å¤±è´¥åœ°å€å·²å¤åˆ¶ï¼");
    });
  };
</script>
